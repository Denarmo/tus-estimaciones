function main(){favorites=[];var e=localStorage.getItem("favorites");if(null!==e)try{favorites=JSON.parse(e)}catch(e){console.error("Error parsing favorites data.")}if("https:"==location.protocol)return alert("Reddireccionando a HTTP para acceder a las estimaciones..."),void location.replace("http://"+location.host+location.pathname);checkPage(!0);var t=document.getElementById("header-left");t.onclick=function(){ga("send","event","Header","Back_Button"),history.back()};var a=document.getElementById("favorite-button");a.onclick=function(){ga("send","event","Header","Favorite_Button"),toggleFavorite()}}function checkPage(e){QueryString.parada&&QueryString.linea&&QueryString.estimaciones?getEstimations(QueryString.parada,QueryString.linea,!1,!1):QueryString.parada&&QueryString.estimaciones?getAllEstimations(QueryString.parada,!1):QueryString.linea&&QueryString.parada&&QueryString.ruta?getStopsRoute(QueryString.linea,QueryString.parada,!1):createHome(!1)}function updateTitle(e,t){var a=(document.getElementById("back-button"),document.getElementById("header-center"));document.getElementById("favorite-button");document.title=e,void 0===t?a.children[0].innerHTML=e:a.children[0].innerHTML=t}function toggleFavorite(){var e=document.getElementById("favorite-button"),t=e.dataset.stopId,a=e.dataset.stopName,n=e.dataset.line,o=checkFavorite(t,n);null===o?(addFavorite(t,a,n),e.style.opacity=1,e.setAttribute("title","Quitar de favoritos")):(removeFavorite(t,n),e.style.opacity=.6,e.setAttribute("title","Añadir a favoritos")),localStorage.setItem("favorites",JSON.stringify(favorites))}function checkFavorite(e,t){for(var a=null,n=favorites.length-1;n>=0;n--)favorites[n].stop_id==e&&(void 0===t&&void 0===favorites[n].line?a=favorites[n]:void 0!==t&&void 0!==favorites[n].line&&favorites[n].line==t&&(a=favorites[n]));return a}function addFavorite(e,t,a){var n={};void 0===a?(n.stop_id=e,n.stop_name=t):(n.stop_id=e,n.stop_name=t,n.line=a),favorites.push(n),console.log("Favorite added.")}function removeFavorite(e,t){var a=checkFavorite(e,t),n=favorites.indexOf(a);n>-1&&(favorites.splice(n,1),console.log("Favorite deleted."))}function showFavoriteButton(e,t,a){var n=document.getElementById("favorite-button"),o=t||n.dataset.stopName,r=checkFavorite(e,a);null===r?(n.style.opacity=.6,n.setAttribute("title","Añadir a favoritos")):(n.style.opacity=1,n.setAttribute("title","Quitar de favoritos")),n.setAttribute("data-stop-id",e),void 0===o?n.removeAttribute("data-stop-name"):n.setAttribute("data-stop-name",o),void 0===a?n.removeAttribute("data-line"):n.setAttribute("data-line",a),n.style.display="block",console.log("Favorite button updated.")}function createHome(e){document.title="Estimaciones de TUS",document.body.className="home",e&&(history.pushState(null,"Estimaciones de TUS",location.pathname),console.log("History state pushed.")),ga("set","page",location.pathname),ga("send","pageview");var t=document.getElementById("back-button");t.style.display="none";var a=document.getElementById("header-center");a.children[0].innerHTML="Estimaciones";var n=document.getElementById("favorite-button");n.style.display="none";var o=document.getElementById("content");o.className="home",o.innerHTML="";var r=document.createElement("a");r.id="map-link",r.href="https://tus-estimaciones.appspot.com/mapa",o.appendChild(r);var i=document.createElement("img");i.id="map-img",i.src="/images/map-min.png",r.appendChild(i);var s=document.createElement("div");s.id="map-button",s.className="long-button",r.appendChild(s);var d=document.createElement("span");d.innerHTML="Mapa de paradas",s.appendChild(d);var c=document.createElement("div");c.id="ask-stop-button",c.className="long-button",o.appendChild(c);var l=document.createElement("input");l.setAttribute("type","number"),l.setAttribute("pattern","\\d*"),l.placeholder="Número de parada",c.appendChild(l),l.onkeypress=function(e){13==e.keyCode&&l.blur()},l.onblur=function(e){ga("send","event","Home","Ask_Stop_Button"),""!==l.value&&getAllEstimations(l.value,!0)};var u=document.createElement("div");if(u.id="favorites",o.appendChild(u),0===favorites.length){var p=document.createElement("div");p.id="favorite-information",u.appendChild(p);var m=document.createElement("div");m.className="text",m.innerHTML="Usa el corazón en la parte superior de la derecha para añadir paradas o lineas favoritas.",p.appendChild(m)}else for(var v=0;v<favorites.length;v++){var g=document.createElement("div");g.className="long-button",u.appendChild(g);var y=document.createElement("span");void 0===favorites[v].line?y.innerHTML=favorites[v].stop_name:y.innerHTML=favorites[v].stop_name+": Linea "+favorites[v].line,g.onclick=function(e){return function(){ga("send","event","Home","Favorite_Button");var t=favorites[e].stop_id,a=favorites[e].line;void 0===a?getAllEstimations(t,!0):getEstimations(t,a,!0,!1)}}(v),g.appendChild(y)}}function createLoading(e,t){var a=document.createElement("div");a.id="loading",e.appendChild(a);var n=document.createElement("p");n.innerHTML=t,a.appendChild(n)}function createError(e,t){var a=document.createElement("div");a.id="error",e.appendChild(a);var n=document.createElement("p");n.innerHTML=t,a.appendChild(n)}function checkTime(e,t){for(var a=e,n=0;n<a.length;n++){var o=a[n];""!==o[t]&&"0"!=o[t]||(o[t]="999999999")}return a}function sortByKey(e,t){return e.sort(function(e,a){var n=parseInt(e[t]),o=parseInt(a[t]);return n<o?-1:n>o?1:0})}function createTime(e,t,a){var n="No hay estimación disponible.";if(t>-1&&t<999999){var o=Math.floor(t/60);t-=60*o;var r=null,i=null;1==o?r=o+" minuto":o>1&&(r=o+" minutos"),1==t?i=t+" segundo":t>1&&(i=t+" segundos");var s=[r,i];o>0&&t>0?n=s.join(" y "):o>0?n=r:t>0&&(n=i)}t<1&&(n="En parada (aprox.)");var d=document.createElement("p");d.className=a,d.innerHTML=n,e.appendChild(d)}function getAllEstimations(e,t,a){document.title="Parada "+e,document.body.className="stop-estimations";var n=document.getElementById("back-button");n.style.display="block";var o=document.getElementById("favorite-button");o.style.display="none";var r=document.getElementById("content");if(r.innerHTML="",t){var i={stop_id:e,estimations:!0};history.pushState(i,"Parada "+e,location.pathname+"?parada="+e+"&estimaciones=true"),console.log("History state pushed.")}ga("set","page",location.pathname+"?parada="+e+"&estimaciones=true"),ga("send","pageview"),a?showFavoriteButton(e):getStopName(e),createLoading(r,"Descargando estimaciones...");var s="?query=ayto%5C:paradaId:"+e,d=new XMLHttpRequest;d.onreadystatechange=function(){if(4==this.readyState){r.innerHTML="";var t=document.createElement("div");if(t.id="lines",r.appendChild(t),200!=this.status)return createError(t,"Error al descargar estimaciones."),void createUserOptions("stop_estimations",e,null,!0);var a=null;try{a=JSON.parse(this.responseText)}catch(a){return console.error("Error parsing stops data."),createError(t,"Error al descargar estimaciones."),void createUserOptions("stop_estimations",e,null,!0)}if(null===a||!("resources"in a)||0===a.resources.length)return createError(t,"Error en la datos de las estimaciones."),void createUserOptions("stop_estimations",e,null,!0);var n=a.resources;n=checkTime(n,"ayto:tiempo1"),n=sortByKey(n,"ayto:tiempo1");for(var o=0;o<n.length;o++){var i=a.resources[o];if("ayto:etiqLinea"in i&&"ayto:tiempo1"in i&&"ayto:tiempo2"in i&&"dc:modified"in i){var s=i["ayto:etiqLinea"],d=Date.now()-Date.parse(i["dc:modified"]),c=parseInt(d/1e3%60),l=parseInt(i["ayto:tiempo1"])-c,u=parseInt(i["ayto:tiempo2"])-c,p=document.createElement("div");p.className="line",t.appendChild(p),p.onclick=function(t){return function(){ga("send","event","Bus_Stop","Line_Estimations");var a=n[t]["ayto:etiqLinea"];getEstimations(e,a,!0,!1)}}(o);var m=document.createElement("p");m.innerHTML="Linea "+s,p.appendChild(m),createTime(p,l,"time1"),createTime(p,u,"time2")}else createError(t,"Error en la datos de las estimaciones."),createUserOptions("stop_estimations",e,null,!0)}createSource()}},d.open("GET",URL_ESTIMATIONS+s+FIELDS_ESTIMATIONS,!0),d.send()}function getEstimations(e,t,a,n){document.title="Linea "+t,document.body.className="line-estimations";var o=document.getElementById("back-button");o.style.display="block";var r=document.getElementById("favorite-button");r.style.display="none";var i=document.getElementById("content");if(i.innerHTML="",a){var s={line:t,stop_id:e,estimations:!0};history.pushState(s,"Linea "+t,location.pathname+"?parada="+e+"&linea="+t+"&estimaciones=true"),console.log("History state pushed.")}ga("set","page",location.pathname+"?parada="+e+"&linea="+t+"&estimaciones=true"),ga("send","pageview"),n?showFavoriteButton(e,void 0,t):getStopName(e,t),createLoading(i,"Descargando estimaciones...");var d="?query=ayto%5C:paradaId:"+e+" AND ayto%5C:etiqLinea:"+t,c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==this.readyState){i.innerHTML="";var a=document.createElement("div");if(a.id="lines",i.appendChild(a),200!=this.status)return createError(a,"Error al descargar estimaciones."),void createUserOptions("line_estimations",e,t,!0);var n=null;try{n=JSON.parse(this.responseText)}catch(n){return console.error("Error parsing stops data."),createError(a,"Error en la datos de las estimaciones."),void createUserOptions("line_estimations",e,t,!0)}if(null===n||!("resources"in n)||0===n.resources.length)return createError(a,"Error en la datos de las estimaciones."),void createUserOptions("line_estimations",e,t,!0);var o=n.resources,r=o[0];if(!("ayto:etiqLinea"in r&&"ayto:tiempo1"in r&&"ayto:tiempo2"in r&&"dc:modified"in r))return createError(a,"Error en la datos de las estimaciones."),void createUserOptions("line_estimations",e,t,!0);var s=(r["ayto:etiqLinea"],Date.now()-Date.parse(r["dc:modified"])),d=parseInt(s/1e3%60),c=parseInt(r["ayto:tiempo1"])-d,l=parseInt(r["ayto:tiempo2"])-d,u=document.createElement("div");u.className="line",a.appendChild(u);var p=document.createElement("p");p.innerHTML="Linea "+t,u.appendChild(p),createTime(u,c,"time1"),createTime(u,l,"time2"),createUserOptions("line_estimations",e,t,!1),createSource()}},c.open("GET",URL_ESTIMATIONS+d+FIELDS_ESTIMATIONS,!0),c.send()}function createUserOptions(e,t,a,n){var o=document.getElementById("content"),r=document.createElement("div");if(r.id="bus-buttons",o.appendChild(r),"line_estimations"==e||"stops_route"==e){var i=document.createElement("div");i.className="long-button",r.appendChild(i),i.onclick=function(){ga("send","event","Bus_Line","Stops_Route_Button"),getStopsRoute(a,t,!0)};var s=document.createElement("span");"stops_route"==e&&n?s.innerHTML="Refrescar":s.innerHTML="Ruta de paradas",i.appendChild(s)}if("stop_estimations"==e||"line_estimations"==e){var d=document.createElement("div");d.className="long-button",r.appendChild(d),d.onclick=function(){null===a?(ga("send","event","Bus_Line","Refresh_Stop_Estimations_Button"),getAllEstimations(t,!1,!n)):(ga("send","event","Bus_Line","Refresh_Line_Estimations_Button"),getEstimations(t,a,!1,!n))};var c=document.createElement("span");c.innerHTML="Refrescar",d.appendChild(c)}}function getStopsRoute(e,t,a){document.title="Linea "+e,document.body.className="stops-route";var n=document.getElementById("back-button");n.style.display="block";var o=document.getElementById("favorite-button");o.style.display="none",updateTitle("Ruta de la Linea "+e,"Linea "+e);var r=document.getElementById("content");if(r.innerHTML="",a){var i={line:e,stop_id:t,route:!0};history.pushState(i,"Linea "+e,location.pathname+"?linea="+e+"&parada="+t+"&ruta=true"),console.log("History state pushed.")}ga("set","page",location.pathname+"?linea="+e+"&parada="+t+"&ruta=true"),ga("send","pageview"),createLoading(r,"Descargando secuencia de rutas...");var s="?line="+e+"&stop_id="+t,d=new XMLHttpRequest;d.onreadystatechange=function(){if(4==this.readyState){r.innerHTML="";var a=document.createElement("div");if(a.id="stops",r.appendChild(a),200!=this.status)return createError(a,"Error al descargar la secuencia de paradas."),void createUserOptions("stops_route",t,e,!0);var n=null;try{n=JSON.parse(this.responseText)}catch(n){return createError(a,"Error al descargar la secuencia de paradas."),void createUserOptions("stops_route",t,e,!0)}if(!Array.isArray(n))return createError(a,"Error al descargar la secuencia de paradas."),void createUserOptions("stops_route",t,e,!0);for(var o=0;o<n.length;o++){var i=n[o],s=document.createElement("div");s.className="stop",a.appendChild(s);var d=document.createElement("p");d.innerHTML=i,s.appendChild(d)}createSource()}},d.open("GET",PATH_STOPS_ROUTE+s,!0),d.send()}function getStopName(e,t){var a=(document.getElementById("back-button"),document.getElementById("header-center"),"Descargando...");updateTitle(a);var n="?query=ayto%5C:numero:"+e,o=new XMLHttpRequest;o.onreadystatechange=function(){if(4==this.readyState){if(200!=this.status)return a="Parada desconocida",void updateTitle(a);var n=!1,o=null;try{o=JSON.parse(this.responseText)}catch(e){console.error("Error parsing stop name data.")}if(null!==o&&"resources"in o&&0!==o.resources.length){var r=o.resources[0];"ayto:parada"in r?(a=r["ayto:parada"],n=!0,updateTitle(a)):(a="Parada desconocida",updateTitle(a))}else a="Parada desconocida",updateTitle(a);if(console.log("Stop name updated."),n===!1)return;showFavoriteButton(e,a,t)}},o.open("GET",URL_STOPS+n+FIELDS_STOPS,!0),o.send()}function createSource(){var e=document.getElementById("content"),t=document.createElement("div");t.id="source",e.appendChild(t);var a=document.createElement("p");a.innerHTML='Fuente de los datos: <a href="http://datos.santander.es">Ayuntamiento de Santander</a>.',t.appendChild(a)}var URL_ESTIMATIONS="http://datos.santander.es/rest/datasets/control_flotas_estimaciones.json",URL_STOPS="http://datos.santander.es/rest/datasets/paradas_bus.json",FIELDS_ESTIMATIONS="&data=ayto:tiempo1,ayto:tiempo2,ayto:etiqLinea,dc:modified",FIELDS_STOPS="&data=ayto:parada",PATH_STOPS_ROUTE="/json/lineas-bus-secuencia",favorites=null,QueryString=function(){for(var e={},t=window.location.search.substring(1),a=t.split("&"),n=0;n<a.length;n++){var o=a[n].split("=");if("undefined"==typeof e[o[0]])e[o[0]]=decodeURIComponent(o[1]);else if("string"==typeof e[o[0]]){var r=[e[o[0]],decodeURIComponent(o[1])];e[o[0]]=r}else e[o[0]].push(decodeURIComponent(o[1]))}return e}();window.onpopstate=function(e){e.state?(console.log("History",e.state),e.state.stop_id&&e.state.line&&e.state.estimations?getEstimations(e.state.stop_id,e.state.line,!1,!1):e.state.stop_id&&e.state.estimations?getAllEstimations(e.state.stop_id,!1):e.state.line&&e.state.stop_id&&e.state.route&&getStopsRoute(e.state.line,e.state.stop_id,!1)):checkPage(!1)},main();